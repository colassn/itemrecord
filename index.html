<!DOCTYPE html>
<html lang="zh-HK">
<head>
  <meta charset="UTF-8">
  <title>小食部記帳</title>
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <meta name="theme-color" content="#ffffff">
  <meta name="mobile-web-app-capable" content="yes">
  
  <link rel="manifest" href="manifest.json">

  <script src="https://cdn.tailwindcss.com"></script>
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://unpkg.com/lucide@latest"></script>

  <style>
    body {
      -webkit-tap-highlight-color: transparent;
      overscroll-behavior-y: none;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
      background-color: #F5F5F7;
    }
    input, select, textarea { font-size: 16px !important; }
    .safe-top { padding-top: env(safe-area-inset-top); }
    .safe-bottom { padding-bottom: env(safe-area-inset-bottom); }
    .scrollbar-hide::-webkit-scrollbar { display: none; }
    .scrollbar-hide { -ms-overflow-style: none; scrollbar-width: none; }
    @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }
    .animate-slide-up { animation: slideUp 0.3s cubic-bezier(0.16, 1, 0.3, 1) forwards; }
  </style>
</head>
<body class="text-gray-900 h-screen overflow-hidden select-none">
  
  <div id="root"></div>

  <script type="text/babel" data-type="module">
    const { useState, useEffect, useMemo } = React;
    
    // 引入 Firebase 模組
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
    import { getAnalytics } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-analytics.js";
    import { 
      getAuth, 
      signInWithRedirect, // 改用 Redirect
      getRedirectResult,  // 獲取 Redirect 結果
      GoogleAuthProvider, 
      signOut, 
      onAuthStateChanged 
    } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";
    import { 
      getFirestore, 
      collection, 
      addDoc, 
      onSnapshot, 
      doc, 
      setDoc, 
      deleteDoc, 
      serverTimestamp,
      query,
      orderBy
    } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyA4SVxeJVjeFQZ924SGgYLFkDenj89H2wI",
      authDomain: "tuckshoprecord.firebaseapp.com",
      projectId: "tuckshoprecord",
      storageBucket: "tuckshoprecord.firebasestorage.app",
      messagingSenderId: "10691492783",
      appId: "1:10691492783:web:5aaad9938189a2448dcd5a",
      measurementId: "G-DCG0MCG6FD"
    };

    const app = initializeApp(firebaseConfig);
    const analytics = getAnalytics(app);
    const auth = getAuth(app);
    const db = getFirestore(app);
    
    const ADMIN_EMAIL = 'chimhinhin@gmail.com';

    const Icon = ({ name, size = 24, className }) => {
      useEffect(() => { if (window.lucide) window.lucide.createIcons(); }, [name]);
      return <i data-lucide={name} width={size} height={size} className={className}></i>;
    };

    function App() {
      const [user, setUser] = useState(null);
      const [loading, setLoading] = useState(true);
      const [loginError, setLoginError] = useState(""); // 新增錯誤狀態
      
      const [transactions, setTransactions] = useState([]);
      const [budget, setBudget] = useState(500);
      const [presets, setPresets] = useState([
        { id: 'p1', name: '維他奶', price: 6.5, icon: 'coffee' },
        { id: 'p2', name: '腿蛋治', price: 12, icon: 'sandwich' },
        { id: 'p3', name: '燒賣 (5粒)', price: 10, icon: 'utensils' },
        { id: 'p4', name: '薯片', price: 8, icon: 'shopping-bag' },
      ]);
      
      const [showAddModal, setShowAddModal] = useState(false);
      const [showSettings, setShowSettings] = useState(false);
      const [currentDate, setCurrentDate] = useState(new Date());
      const [newItemName, setNewItemName] = useState('');
      const [newItemPrice, setNewItemPrice] = useState('');
      const [selectedIcon, setSelectedIcon] = useState('utensils');

      // 1. 檢查登入狀態與重新導向結果
      useEffect(() => {
        // 檢查 Redirect 回來後的錯誤
        getRedirectResult(auth).catch((error) => {
          console.error(error);
          alert("登入錯誤: " + error.message); // 手機上彈出錯誤
          setLoginError(error.message);
        });

        // 監聽一般狀態變化
        const unsubscribe = onAuthStateChanged(auth, (u) => {
          setUser(u);
          setLoading(false);
        });
        return () => unsubscribe();
      }, []);

      // 2. 獲取數據
      useEffect(() => {
        if (!user) return;
        
        const q = query(collection(db, 'users', user.uid, 'transactions'), orderBy('date', 'desc'));
        const unsubTx = onSnapshot(q, (snap) => {
           const txs = snap.docs.map(d => ({
             id: d.id,
             ...d.data(),
             date: d.data().date?.toDate() || new Date()
           }));
           setTransactions(txs);
        }, (error) => {
           if (error.code === 'failed-precondition') {
              // Fallback for missing index
              onSnapshot(collection(db, 'users', user.uid, 'transactions'), (snap) => {
                 const txs = snap.docs.map(d => ({ id: d.id, ...d.data(), date: d.data().date?.toDate() || new Date() }));
                 txs.sort((a,b) => b.date - a.date);
                 setTransactions(txs);
              });
           }
        });

        const unsubSettings = onSnapshot(doc(db, 'users', user.uid, 'config', 'main'), (snap) => {
           if(snap.exists()) {
             const d = snap.data();
             if(d.budget) setBudget(d.budget);
             if(d.presets) setPresets(d.presets);
           }
        });

        return () => { unsubTx && unsubTx(); unsubSettings(); };
      }, [user]);

      // --- Actions ---
      const handleLogin = () => {
        setLoginError("");
        // 使用 Redirect 解決手機彈窗攔截問題
        signInWithRedirect(auth, new GoogleAuthProvider());
      };

      const handleAdd = async () => {
        if(!newItemName || !newItemPrice) return;
        try {
          await addDoc(collection(db, 'users', user.uid, 'transactions'), {
            name: newItemName,
            price: parseFloat(newItemPrice),
            icon: selectedIcon,
            date: serverTimestamp()
          });
          setShowAddModal(false);
          setNewItemName('');
          setNewItemPrice('');
        } catch(e) {
          alert("錯誤: " + e.message);
        }
      };

      const handleDelete = async (id) => {
        if(confirm("刪除此紀錄？")) {
          await deleteDoc(doc(db, 'users', user.uid, 'transactions', id));
        }
      };
      
      const handleSaveSettings = async () => {
         await setDoc(doc(db, 'users', user.uid, 'config', 'main'), {
           budget: parseFloat(budget),
           presets: presets
         }, { merge: true });
         setShowSettings(false);
      };

      // --- Render Logic ---
      const filteredTxs = transactions.filter(t => 
        t.date.getMonth() === currentDate.getMonth() && 
        t.date.getFullYear() === currentDate.getFullYear()
      );
      const totalSpent = filteredTxs.reduce((acc, curr) => acc + (curr.price || 0), 0);
      const remaining = budget - totalSpent;

      if (loading) return (
        <div className="h-screen flex items-center justify-center bg-[#F5F5F7]">
          <div className="w-10 h-10 border-4 border-gray-200 border-t-black rounded-full animate-spin"></div>
        </div>
      );

      // Login Screen
      if (!user) return (
        <div className="h-screen flex flex-col items-center justify-center p-6 bg-[#F5F5F7]">
          <div className="bg-white p-8 rounded-[2rem] shadow-xl w-full max-w-sm text-center">
            <div className="mb-6 flex justify-center text-blue-600">
               <Icon name="wallet" size={48} />
            </div>
            <h1 className="text-2xl font-bold mb-2">小食部記帳</h1>
            <p className="text-gray-400 mb-8 text-sm">手機版專用</p>
            
            <button onClick={handleLogin} className="w-full bg-black text-white py-4 rounded-xl font-bold active:scale-95 transition-transform flex items-center justify-center gap-2">
              <Icon name="log-in" size={18} />
              Google 登入
            </button>
            
            {loginError && (
              <p className="mt-4 text-xs text-red-500 font-bold bg-red-50 p-2 rounded-lg">
                錯誤: {loginError} <br/>
                請檢查 Firebase Console 的 Authorized Domains
              </p>
            )}
          </div>
        </div>
      );

      // Main App Interface
      return (
        <div className="flex flex-col h-full max-w-md mx-auto bg-white sm:shadow-2xl sm:min-h-screen relative">
          
          <header className="pt-safe-top mt-4 pb-2 px-6 bg-white sticky top-0 z-10 flex justify-between items-center">
             <div>
                <p className="text-[10px] text-gray-400 font-bold uppercase tracking-wider">WELCOME</p>
                <h2 className="text-xl font-extrabold flex items-center gap-2">
                   {user.displayName?.split(' ')[0]}
                   {user.email === ADMIN_EMAIL && <span className="bg-black text-white text-[10px] px-2 py-0.5 rounded-full">ADMIN</span>}
                </h2>
             </div>
             <button onClick={() => setShowSettings(true)} className="w-10 h-10 bg-gray-50 rounded-full flex items-center justify-center active:scale-95 transition-transform">
                <Icon name="settings" size={20} className="text-gray-600" />
             </button>
          </header>

          <div className="flex-1 overflow-y-auto pb-32 scrollbar-hide px-6 pt-2">
             <div className="flex justify-between items-center mb-6 bg-gray-50 p-1 rounded-2xl">
                <button onClick={() => setCurrentDate(new Date(currentDate.setMonth(currentDate.getMonth()-1)))} className="p-2 text-gray-400 hover:text-black"><Icon name="chevron-left" /></button>
                <span className="text-lg font-bold tabular-nums">{currentDate.getFullYear()} <span className="text-gray-300">/</span> {currentDate.getMonth()+1}月</span>
                <button onClick={() => setCurrentDate(new Date(currentDate.setMonth(currentDate.getMonth()+1)))} className="p-2 text-gray-400 hover:text-black"><Icon name="chevron-right" /></button>
             </div>

             <div className="bg-white border border-gray-100 shadow-[0_8px_30px_rgb(0,0,0,0.04)] rounded-[2rem] p-6 mb-8 relative overflow-hidden">
                <div className="flex justify-between items-end mb-5">
                   <div>
                      <p className="text-[10px] font-bold text-gray-400 uppercase tracking-wider mb-1">本月支出</p>
                      <div className="text-5xl font-extrabold flex items-baseline tracking-tight">
                         <span className="text-2xl mr-1 text-gray-300 font-medium">$</span>
                         {totalSpent.toFixed(1)}
                      </div>
                   </div>
                   <div className="text-right">
                      <div className={`text-sm font-bold px-2 py-1 rounded-lg inline-block mb-1 ${remaining < 0 ? 'bg-red-50 text-red-500' : 'bg-emerald-50 text-emerald-600'}`}>
                         ${remaining.toFixed(1)}
                      </div>
                      <p className="text-[10px] text-gray-300 font-bold uppercase">餘額</p>
                   </div>
                </div>
                <div className="w-full bg-gray-100 h-3 rounded-full overflow-hidden">
                   <div className={`h-full transition-all duration-1000 ease-out ${remaining < 0 ? 'bg-red-500' : 'bg-emerald-500'}`} style={{width: Math.min((totalSpent/budget)*100, 100) + '%'}}></div>
                </div>
                <div className="flex justify-between mt-2 text-[10px] font-bold text-gray-300">
                   <span>$0</span>
                   <span>預算 ${budget}</span>
                </div>
             </div>

             <div className="mb-8">
                <h3 className="text-xs font-bold text-gray-900 uppercase tracking-wider mb-4 px-1">快速記帳</h3>
                <div className="flex gap-3 overflow-x-auto pb-4 scrollbar-hide -mx-6 px-6 snap-x">
                   {presets.map(p => (
                      <button key={p.id} onClick={() => { setNewItemName(p.name); setNewItemPrice(p.price); setSelectedIcon(p.icon); setTimeout(() => handleAdd(), 100); }} 
                        className="snap-start flex-shrink-0 w-20 h-24 bg-white border border-gray-100 rounded-2xl flex flex-col items-center justify-center shadow-sm active:scale-95 transition-transform active:border-black">
                         <div className="text-gray-400 mb-2"><Icon name={p.icon} size={22} /></div>
                         <span className="text-xs font-bold text-gray-800 truncate w-full px-1 text-center">{p.name}</span>
                         <span className="text-[10px] text-gray-400 mt-0.5">${p.price}</span>
                      </button>
                   ))}
                </div>
             </div>

             <div>
                <h3 className="text-xs font-bold text-gray-900 uppercase tracking-wider mb-4 px-1">最近紀錄 ({filteredTxs.length})</h3>
                <div className="space-y-3 pb-safe-bottom">
                   {filteredTxs.map(tx => (
                      <div key={tx.id} className="flex justify-between items-center p-4 bg-white border border-gray-100 rounded-2xl shadow-sm active:bg-gray-50 transition-colors">
                         <div className="flex items-center gap-4">
                            <div className="w-12 h-12 bg-gray-50 rounded-2xl flex items-center justify-center text-gray-400">
                               <Icon name={tx.icon} size={20} />
                            </div>
                            <div>
                               <p className="font-bold text-gray-900">{tx.name}</p>
                               <p className="text-[10px] text-gray-400 font-medium mt-0.5">
                                  {tx.date.getDate()}日 {tx.date.getHours().toString().padStart(2,'0')}:{tx.date.getMinutes().toString().padStart(2,'0')}
                                </p>
                            </div>
                         </div>
                         <div className="flex items-center gap-4">
                            <span className="font-bold text-lg tracking-tight">-${tx.price}</span>
                            <button onClick={() => handleDelete(tx.id)} className="w-8 h-8 flex items-center justify-center text-gray-300 hover:text-red-500 rounded-full active:bg-red-50 transition-colors"><Icon name="trash-2" size={16} /></button>
                         </div>
                      </div>
                   ))}
                   {filteredTxs.length === 0 && (
                      <div className="text-center py-12">
                         <div className="w-16 h-16 bg-gray-100 rounded-full flex items-center justify-center mx-auto mb-4 text-gray-300">
                            <Icon name="shopping-bag" size={24} />
                         </div>
                         <p className="text-gray-400 text-sm font-medium">這個月還沒有消費</p>
                      </div>
                   )}
                </div>
             </div>
          </div>

          <button onClick={() => setShowAddModal(true)} className="absolute bottom-8 right-6 w-16 h-16 bg-black text-white rounded-[2rem] flex items-center justify-center shadow-2xl shadow-gray-400/50 active:scale-90 transition-transform duration-300 z-20">
             <Icon name="plus" size={32} />
          </button>

          {showAddModal && (
             <div className="fixed inset-0 z-50 bg-black/40 backdrop-blur-sm flex items-end sm:items-center justify-center">
                <div className="bg-white w-full max-w-sm rounded-t-[2rem] sm:rounded-[2rem] p-6 pb-10 animate-slide-up shadow-2xl">
                   <div className="flex justify-between items-center mb-8">
                      <h3 className="text-xl font-extrabold text-gray-900">記一筆</h3>
                      <button onClick={() => setShowAddModal(false)} className="w-8 h-8 bg-gray-100 rounded-full flex items-center justify-center text-gray-500 active:scale-90"><Icon name="x" size={18} /></button>
                   </div>
                   
                   <div className="space-y-4">
                      <div>
                         <label className="text-[10px] font-bold text-gray-400 uppercase tracking-wider pl-1 mb-1 block">名稱</label>
                         <input type="text" placeholder="例如：魚蛋" value={newItemName} onChange={e => setNewItemName(e.target.value)} className="w-full bg-gray-50 border border-gray-100 p-4 rounded-xl font-bold text-lg outline-none focus:border-black focus:ring-1 focus:ring-black/5 transition-all" autoFocus />
                      </div>
                      <div>
                         <label className="text-[10px] font-bold text-gray-400 uppercase tracking-wider pl-1 mb-1 block">價錢</label>
                         <div className="relative">
                            <span className="absolute left-4 top-1/2 -translate-y-1/2 text-gray-400 font-bold">$</span>
                            <input type="number" placeholder="0.0" value={newItemPrice} onChange={e => setNewItemPrice(e.target.value)} className="w-full bg-gray-50 border border-gray-100 p-4 pl-8 rounded-xl font-bold text-lg outline-none focus:border-black focus:ring-1 focus:ring-black/5 transition-all" inputMode="decimal" />
                         </div>
                      </div>
                      <div>
                         <label className="text-[10px] font-bold text-gray-400 uppercase tracking-wider pl-1 mb-2 block">類別</label>
                         <div className="flex gap-3 overflow-x-auto pb-2 scrollbar-hide">
                            {['utensils', 'coffee', 'sandwich', 'pizza', 'ice-cream', 'shopping-bag'].map(icon => (
                               <button key={icon} onClick={() => setSelectedIcon(icon)} className={`flex-shrink-0 w-14 h-14 rounded-2xl border-2 flex items-center justify-center transition-all ${selectedIcon === icon ? 'bg-black text-white border-black shadow-lg' : 'bg-white border-gray-100 text-gray-300'}`}>
                                  <Icon name={icon} size={24} />
                               </button>
                            ))}
                         </div>
                      </div>
                      <button onClick={handleAdd} disabled={!newItemName || !newItemPrice} className="w-full bg-black text-white py-4 rounded-xl font-bold text-lg shadow-xl shadow-black/10 mt-2 active:scale-95 transition-transform disabled:opacity-50 disabled:active:scale-100">
                         確認新增
                      </button>
                   </div>
                </div>
             </div>
          )}

          {showSettings && (
             <div className="fixed inset-0 z-50 bg-gray-100/50 backdrop-blur-md flex items-end sm:items-center justify-center p-4">
                <div className="bg-white w-full max-w-sm rounded-[2rem] shadow-2xl p-6 h-[80vh] flex flex-col animate-slide-up">
                   <div className="flex justify-between items-center mb-6">
                      <h3 className="text-xl font-extrabold flex items-center gap-2"><Icon name="settings" size={20} /> 設定</h3>
                      <button onClick={() => setShowSettings(false)} className="w-8 h-8 bg-gray-100 rounded-full flex items-center justify-center text-gray-500"><Icon name="x" size={18} /></button>
                   </div>
                   
                   <div className="flex-1 overflow-y-auto space-y-8 scrollbar-hide pb-4">
                      <div>
                         <label className="block text-sm font-bold text-gray-900 mb-2">每月預算 ($)</label>
                         <input type="number" value={budget} onChange={e => setBudget(e.target.value)} className="w-full bg-gray-50 border border-gray-100 p-4 rounded-xl font-bold text-xl outline-none focus:border-black" />
                      </div>
                      <div>
                         <label className="block text-sm font-bold text-gray-900 mb-3">菜單管理</label>
                         <div className="space-y-2">
                           {presets.map((p, i) => (
                              <div key={p.id} className="flex gap-2 items-center">
                                 <div className="w-10 h-10 rounded-lg bg-gray-50 flex items-center justify-center text-gray-400 shrink-0"><Icon name={p.icon} size={18} /></div>
                                 <input value={p.name} onChange={e => { const n = [...presets]; n[i].name = e.target.value; setPresets(n); }} className="flex-1 bg-white border-b border-gray-200 py-2 text-sm font-bold outline-none focus:border-black" />
                                 <input type="number" value={p.price} onChange={e => { const n = [...presets]; n[i].price = e.target.value; setPresets(n); }} className="w-16 bg-white border-b border-gray-200 py-2 text-sm font-bold text-center outline-none focus:border-black" />
                              </div>
                           ))}
                         </div>
                      </div>
                   </div>

                   <div className="pt-4 border-t border-gray-100 space-y-3">
                      <button onClick={handleSaveSettings} className="w-full bg-black text-white py-4 rounded-xl font-bold text-lg shadow-lg active:scale-95 transition-transform">儲存設定</button>
                      <button onClick={() => signOut(auth)} className="w-full bg-red-50 text-red-500 py-4 rounded-xl font-bold text-lg active:scale-95 transition-transform flex items-center justify-center gap-2">
                        <Icon name="log-out" size={18} /> 登出帳戶
                      </button>
                   </div>
                </div>
             </div>
          )}

        </div>
      );
    }

    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<App />);
  </script>
</body>
</html>



