<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>My Room App</title>
    
    <!-- 1. ÂºïÂÖ• Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- 2. Ë®≠ÂÆö Import Map -->
    <script type="importmap">
    {
        "imports": {
            "react": "https://esm.sh/react@18.2.0",
            "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
            "lucide-react": "https://esm.sh/lucide-react@0.292.0",
            "firebase/app": "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js",
            "firebase/auth": "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js",
            "firebase/firestore": "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js",
            "firebase/analytics": "https://www.gstatic.com/firebasejs/10.7.1/firebase-analytics.js"
        }
    }
    </script>

    <!-- 3. ÂºïÂÖ• Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <style>
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        
        .animate-slideDown { animation: slideDown 0.3s cubic-bezier(0.16, 1, 0.3, 1) forwards; }
        @keyframes slideDown { from { opacity: 0; transform: scaleY(0.9) translateY(-10px); } to { opacity: 1; transform: scaleY(1) translateY(0); } }

        .animate-slideUp { animation: slideUp 0.4s cubic-bezier(0.16, 1, 0.3, 1) forwards; }
        @keyframes slideUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        
        .animate-fadeIn { animation: fadeIn 0.5s ease-out forwards; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        .animate-bounce-slight { animation: bounceSlight 0.3s infinite alternate; }
        @keyframes bounceSlight { from { transform: translateY(0); } to { transform: translateY(-2px); } }
        
        .animate-scaleIn { animation: scaleIn 0.2s cubic-bezier(0.16, 1, 0.3, 1) forwards; }
        @keyframes scaleIn { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }

        .ease-spring { transition-timing-function: cubic-bezier(0.175, 0.885, 0.32, 1.275); }

        /* ÊµÅÂãïËÉåÊôØÂãïÁï´ */
        @keyframes blob {
            0% { transform: translate(0px, 0px) scale(1); }
            33% { transform: translate(30px, -50px) scale(1.1); }
            66% { transform: translate(-20px, 20px) scale(0.9); }
            100% { transform: translate(0px, 0px) scale(1); }
        }
        .animate-blob { animation: blob 10s infinite; }
        .animation-delay-2000 { animation-delay: 2s; }
        .animation-delay-4000 { animation-delay: 4s; }

        body { -webkit-tap-highlight-color: transparent; }
    </style>
</head>
<body class="bg-gray-50">
    <div id="root"></div>

    <!-- 4. ‰∏ªË¶ÅÊáâÁî®Á®ãÂºèÈÇèËºØ -->
    <script type="text/babel" data-type="module">
        import React, { useState, useEffect, useMemo } from 'react';
        import { createRoot } from 'react-dom/client';
        import { 
            Search, Plus, MapPin, Trash2, Save, X, Zap, Box, Settings, 
            LogOut, Sparkles, Moon, Sun, Check, Home, FolderOpen, User, 
            ChevronRight, Edit3, ArrowRight, Globe, LayoutGrid, Mail, Lock, 
            AlertCircle, ChevronDown, Database, PenLine
        } from 'lucide-react';
        
        import { initializeApp } from "firebase/app";
        import { 
            getAuth, signInWithPopup, GoogleAuthProvider, onAuthStateChanged, signOut,
            createUserWithEmailAndPassword, signInWithEmailAndPassword, updateProfile
        } from "firebase/auth";
        import { 
            getFirestore, collection, addDoc, deleteDoc, updateDoc, doc, onSnapshot, query, orderBy, serverTimestamp 
        } from "firebase/firestore";
        import { getAnalytics } from "firebase/analytics";

        // ==========================================
        // ‚ñº ÊÇ®ÁöÑ Firebase Ë®≠ÂÆö ‚ñº
        // ==========================================
        const firebaseConfig = {
            apiKey: "AIzaSyA4SVxeJVjeFQZ924SGgYLFkDenj89H2wI",
            authDomain: "tuckshoprecord.firebaseapp.com",
            projectId: "tuckshoprecord",
            storageBucket: "tuckshoprecord.firebasestorage.app",
            messagingSenderId: "10691492783",
            appId: "1:10691492783:web:5aaad9938189a2448dcd5a",
            measurementId: "G-DCG0MCG6FD"
        };
        // ==========================================
        
        const app = initializeApp(firebaseConfig);
        const analytics = getAnalytics(app);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const provider = new GoogleAuthProvider();
        const appId = "my-room-v5-mobile";

        const THEME_COLORS = {
            blue: { name: 'Ocean', from: 'from-blue-600', to: 'to-cyan-500', blob: 'bg-blue-300', text: 'text-blue-600', bg: 'bg-blue-500', border: 'border-blue-500', lightBg: 'bg-blue-50' },
            purple: { name: 'Galaxy', from: 'from-purple-600', to: 'to-pink-500', blob: 'bg-purple-300', text: 'text-purple-600', bg: 'bg-purple-500', border: 'border-purple-500', lightBg: 'bg-purple-50' },
            pink: { name: 'Sakura', from: 'from-pink-500', to: 'to-rose-400', blob: 'bg-pink-300', text: 'text-pink-600', bg: 'bg-pink-500', border: 'border-pink-500', lightBg: 'bg-pink-50' },
            orange: { name: 'Sunset', from: 'from-orange-500', to: 'to-amber-500', blob: 'bg-orange-300', text: 'text-orange-600', bg: 'bg-orange-500', border: 'border-orange-500', lightBg: 'bg-orange-50' },
            green: { name: 'Emerald', from: 'from-emerald-600', to: 'to-teal-400', blob: 'bg-emerald-300', text: 'text-emerald-600', bg: 'bg-emerald-500', border: 'border-emerald-500', lightBg: 'bg-emerald-50' },
        };

        const FUN_HEADLINES = {
            'zh-TW': ["Êù±Ë•øÂèàÊâæ‰∏çÂà∞‰∫ÜÔºü", "ÂèàÊúâÊà∞Âà©ÂìÅ‰∫ÜÔºÅ", "Êñ∑Êç®Èõ¢...Â§±ÊïóÔºü", "ÈÄôÊù±Ë•øË¶ÅÊîæÂì™Ôºü", "ÊàøÈñìÂø´ÁàÜÁÇ∏Âï¶ÔºÅ", "Ë®òÊÜ∂ÂäõÊïëÊòüÂú®Ê≠§„ÄÇ", "Âπ´ÂÆÉÊâæÂÄãÂÆ∂Âêß„ÄÇ", "Âà•ÂÜç‰∫Ç‰∏ü‰∫ÜÂñî„ÄÇ", "ÊàëÁöÑÂØ∂Ë≤ùÈÉΩÂú®ÈÄô„ÄÇ", "‰ªäÂ§©Êï¥ÁêÜ‰∫ÜÂóéÔºü", "Êî∂Á¥çÊòØ‰∏ÄÁ®ÆËóùË°ì„ÄÇ", "Âà•ËÆìÊàøÈñìËÆäÈªëÊ¥ûÔºÅ"],
            'zh-CN': ["‰∏úË•øÂèàÊâæ‰∏çÂà∞‰∫ÜÔºü", "ÂèàÊúâÊàòÂà©ÂìÅ‰∫ÜÔºÅ", "Êñ≠ËàçÁ¶ª...Â§±Ë¥•Ôºü", "Ëøô‰∏úË•øË¶ÅÊîæÂì™Ôºü", "ÊàøÈó¥Âø´ÁàÜÁÇ∏Âï¶ÔºÅ", "ËÆ∞ÂøÜÂäõÊïëÊòüÂú®Ê≠§„ÄÇ", "Â∏ÆÂÆÉÊâæ‰∏™ÂÆ∂Âêß„ÄÇ", "Âà´ÂÜç‰π±‰∏¢‰∫ÜÂñî„ÄÇ", "ÊàëÁöÑÂÆùË¥ùÈÉΩÂú®Ëøô„ÄÇ", "‰ªäÂ§©Êï¥ÁêÜ‰∫ÜÂêóÔºü", "Êî∂Á∫≥ÊòØ‰∏ÄÁßçËâ∫ÊúØ„ÄÇ", "Âà´ËÆ©ÊàøÈó¥ÂèòÈªëÊ¥ûÔºÅ"],
            'en': ["Lost something again?", "New loot alert!", "Decluttering failed?", "Where does this go?", "Room exploding soon!", "Memory saver here.", "Give it a home.", "Don't throw it!", "All my treasures.", "Tidied up today?", "Organization is art.", "No more black holes!"]
        };

        const TRANSLATIONS = {
            'zh-TW': {
                tab_home: "È¶ñÈ†Å", tab_explore: "Á©∫Èñì", tab_profile: "Ë®≠ÂÆö", tab_management: "ÂæåÂè∞", welcome: "Ê≠°ËøéÂõûÂà∞",
                greeting: { morning: "Êó©ÂÆâ", afternoon: "ÂçàÂÆâ", evening: "ÊôöÂÆâ" },
                headline_1: "‰ªäÂ§©ÊÉ≥Ë¶Å", headline_2: "Êï¥ÁêÜ‰ªÄÈ∫ºÔºü",
                search_placeholder: "ÊêúÂ∞ãÊàñÁõ¥Êé•Ëº∏ÂÖ•...", select_location: "ÈÅ∏ÊìáÂ≠òÊîæ‰ΩçÁΩÆ",
                save_btn: "Â≠òÂÖ•", ready_save: "ÂèØÂÑ≤Â≠ò", tip: "Tip: Âú®Ê≠§Ëº∏ÂÖ•ÂêçÁ®±Âç≥ÂèØÊêúÂ∞ãÊàñÊñ∞Â¢û",
                overview: "ÊàëÁöÑÁ©∫Èñì", items_stored: "‰ª∂Áâ©ÂìÅ", searching: "ÊêúÂ∞ãÁµêÊûú", recent: "ÊúÄËøëÊñ∞Â¢û",
                no_results: "Ê≤íÊúâÊâæÂà∞Áõ∏ÈóúÁâ©ÂìÅ", add_hint: "ÈªûÊìä‰∏äÊñπÁ´ãÂç≥Êñ∞Â¢û", empty_room: "Á©∫Á©∫Â¶Ç‰πü",
                settings_title: "Ë®≠ÂÆö", appearance: "Â§ñËßÄ", language: "Ë™ûË®Ä", theme_color: "‰∏ªÈ°åËâ≤",
                logout: "ÁôªÂá∫Â∏≥Ëôü", confirm_delete: "ÁßªÈô§Ê≠§È†ÖÁõÆÔºü", delete_loc_confirm: "Á¢∫ÂÆöÂà™Èô§Ôºü",
                manage_rooms: "ÊàøÈñìÁÆ°ÁêÜ", manage_locations: "‰ΩçÁΩÆÁÆ°ÁêÜ", manage_items: "Áâ©ÂìÅÁÆ°ÁêÜ",
                add_new: "Êñ∞Â¢û", search: "ÊêúÂ∞ã...", name: "ÂêçÁ®±", icon: "ÂúñÊ®ô", belongs_to: "ÊâÄÂ±¨",
                my_room: "ÊàëÁöÑÊàøÈñì", cancel: "ÂèñÊ∂à", confirm: "Á¢∫ÂÆö",
                select_room: "ÈÅ∏ÊìáÊàøÈñì", select_location: "ÈÅ∏Êìá‰ΩçÁΩÆ",
                welcome_title: "Ê≠°Ëøé‰æÜÂà∞ My Room", welcome_subtitle: "‰Ω†ÁöÑÂÄã‰∫∫Áâ©ÂìÅÂÆáÂÆô",
                feature_1: "Èö®ÊâãË®òÈåÑ", feature_2: "ËºïÈ¨ÜÊêúÂ∞ã", feature_3: "Á©∫ÈñìÁÆ°ÁêÜ",
                login_btn: "ÊúÉÂì°ÁôªÂÖ•", login_hint: "Â¶ÇÊûúÊÇ®Â∑≤ÊòØÁî®Êà∂ÔºåË´ãÊåâÊ≠§ÁôªÂÖ•",
                select_lang: "ÈÅ∏ÊìáË™ûË®Ä / Select Language",
                no_google: "Ê≤íÊúâ GoogleÔºü‰ΩøÁî®ÈõªÈÉµÂèäÂØÜÁ¢ºË®ªÂÜäÁôªÂÖ•",
                email_ph: "ÈõªÂ≠êÈÉµ‰ª∂", password_ph: "ÂØÜÁ¢º (Ëá≥Â∞ë6‰Ωç)", username_ph: "Áî®Êà∂Âêç (Êö±Á®±)",
                login_submit: "ÁôªÂÖ•", register_submit: "Ë®ªÂÜä",
                switch_to_register: "ÈÇÑÊ≤íÊúâÂ∏≥ËôüÔºüÂéªË®ªÂÜä", switch_to_login: "Â∑≤ÊúâÂ∏≥ËôüÔºüÂéªÁôªÂÖ•",
                back_to_google: "ËøîÂõû Google ÁôªÂÖ•", unknown_loc: "Êú™ÂàÜÈ°û"
            },
            'zh-CN': {
               tab_home: "È¶ñÈ°µ", tab_explore: "Á©∫Èó¥", tab_profile: "ËÆæÁΩÆ", tab_management: "ÂêéÂè∞", welcome: "Ê¨¢ËøéÂõûÂà∞",
               greeting: { morning: "Êó©‰∏äÂ•Ω", afternoon: "‰∏ãÂçàÂ•Ω", evening: "Êôö‰∏äÂ•Ω" },
               headline_1: "‰ªäÂ§©ÊÉ≥Ë¶Å", headline_2: "Êï¥ÁêÜ‰ªÄ‰πàÔºü",
               search_placeholder: "ÊêúÁ¥¢ÊàñÁõ¥Êé•ËæìÂÖ•...", select_location: "ÈÄâÊã©Â≠òÊîæ‰ΩçÁΩÆ",
               save_btn: "Â≠òÂÖ•", ready_save: "ÂèØ‰øùÂ≠ò", tip: "Tip: Âú®Ê≠§ËæìÂÖ•ÂêçÁß∞Âç≥ÂèØÊêúÁ¥¢ÊàñÊñ∞Â¢û",
               overview: "ÊàëÁöÑÁ©∫Èó¥", items_stored: "‰ª∂Áâ©ÂìÅ", searching: "ÊêúÁ¥¢ÁªìÊûú", recent: "ÊúÄËøëÊñ∞Â¢û",
               no_results: "Ê≤°ÊúâÊâæÂà∞Áõ∏ÂÖ≥Áâ©ÂìÅ", add_hint: "ÁÇπÂáª‰∏äÊñπÁ´ãÂç≥Êñ∞Â¢û", empty_room: "Á©∫Á©∫Â¶Ç‰πü",
               settings_title: "ËÆæÁΩÆ", appearance: "Â§ñËßÇ", language: "ËØ≠Ë®Ä", theme_color: "‰∏ªÈ¢òËâ≤",
               logout: "ÈÄÄÂá∫Ë¥¶Âè∑", confirm_delete: "ÁßªÈô§Ê≠§È°πÁõÆÔºü", delete_loc_confirm: "Á°ÆÂÆöÂà†Èô§Ôºü",
               manage_rooms: "ÊàøÈó¥ÁÆ°ÁêÜ", manage_locations: "‰ΩçÁΩÆÁÆ°ÁêÜ", manage_items: "Áâ©ÂìÅÁÆ°ÁêÜ",
               add_new: "Êñ∞Â¢û", search: "ÊêúÁ¥¢...", name: "ÂêçÁß∞", icon: "ÂõæÊ†á", belongs_to: "ÊâÄÂ±û",
               my_room: "ÊàëÁöÑÊàøÈó¥", cancel: "ÂèñÊ∂à", confirm: "Á°ÆÂÆö",
               select_room: "ÈÄâÊã©ÊàøÈó¥", select_location: "ÈÄâÊã©‰ΩçÁΩÆ",
               welcome_title: "Ê¨¢ËøéÊù•Âà∞ My Room", welcome_subtitle: "‰Ω†ÁöÑ‰∏™‰∫∫Áâ©ÂìÅÂÆáÂÆô",
               feature_1: "ÈöèÊâãËÆ∞ÂΩï", feature_2: "ËΩªÊùæÊêúÁ¥¢", feature_3: "Á©∫Èó¥ÁÆ°ÁêÜ",
               login_btn: "‰ºöÂëòÁôªÂΩï", login_hint: "Â¶ÇÊûúÊÇ®Â∑≤ÊòØÁî®Êà∑ÔºåËØ∑ÊåâÊ≠§ÁôªÂΩï",
               select_lang: "ÈÄâÊã©ËØ≠Ë®Ä / Select Language",
               no_google: "Ê≤°Êúâ GoogleÔºü‰ΩøÁî®ÁîµÈÇÆÂèäÂØÜÁ†ÅÊ≥®ÂÜåÁôªÂΩï",
               email_ph: "ÁîµÂ≠êÈÇÆÁÆ±", password_ph: "ÂØÜÁ†Å (Ëá≥Â∞ë6‰Ωç)", username_ph: "Áî®Êà∑Âêç (ÊòµÁß∞)",
               login_submit: "ÁôªÂΩï", register_submit: "Ê≥®ÂÜå",
               switch_to_register: "ËøòÊ≤°ÊúâË¥¶Âè∑ÔºüÂéªÊ≥®ÂÜå", switch_to_login: "Â∑≤ÊúâË¥¶Âè∑ÔºüÂéªÁôªÂΩï",
               back_to_google: "ËøîÂõû Google ÁôªÂΩï", unknown_loc: "Êú™ÂàÜÁ±ª"
            },
            'en': {
               tab_home: "Home", tab_explore: "Explore", tab_profile: "Settings", tab_management: "Admin", welcome: "Welcome back",
               greeting: { morning: "Good Morning", afternoon: "Good Afternoon", evening: "Good Evening" },
               headline_1: "What are we", headline_2: "storing today?",
               search_placeholder: "Search or type to add...", select_location: "Select Location",
               save_btn: "Save", ready_save: "Ready", tip: "Tip: Type above to search or add",
               overview: "My Spaces", items_stored: "items", searching: "Searching", recent: "Recent",
               no_results: "No items found", add_hint: "Tap above to add one!", empty_room: "Nothing here yet",
               settings_title: "Settings", appearance: "Appearance", language: "Language", theme_color: "Theme Color",
               logout: "Log Out", confirm_delete: "Remove?", delete_loc_confirm: "Delete?",
               manage_rooms: "Manage Rooms", manage_locations: "Locations", manage_items: "Items",
               add_new: "Add New", search: "Search...", name: "Name", icon: "Icon", belongs_to: "Belongs To",
               my_room: "My Room", cancel: "Cancel", confirm: "Confirm",
               select_room: "Select Room", select_location: "Select Location",
               welcome_title: "Welcome to My Room", welcome_subtitle: "Your personal inventory universe",
               feature_1: "Track Items", feature_2: "Easy Search", feature_3: "Manage Spaces",
               login_btn: "Login", login_hint: "Already a user? Click here to login",
               select_lang: "Select Language",
               no_google: "No Google? Use Email & Password",
               email_ph: "Email", password_ph: "Password (6+ chars)", username_ph: "Username",
               login_submit: "Login", register_submit: "Register",
               switch_to_register: "Need account? Register", switch_to_login: "Have account? Login",
               back_to_google: "Back to Google Login", unknown_loc: "Unknown"
            }
        };

        const EMOJI_CATEGORIES = { "Â∏∏Áî®": ["üì¶", "üß•", "‚úèÔ∏è", "üóÑÔ∏è"], "ÂÆ∂ÂÖ∑": ["üõèÔ∏è", "üõãÔ∏è", "ü™ë"], "3C": ["üíª", "üì±", "üì∑"], "È£üÁâ©": ["üçé", "‚òï", "üç∑"] };

        // --- Custom UI Components ---

        // 1. Aurora Background
        const AuroraBackground = ({ isDark, colorTheme }) => (
            <div className={`absolute inset-0 overflow-hidden pointer-events-none transition-colors duration-1000 ${isDark ? 'bg-black' : 'bg-white'}`}>
                <div className={`absolute top-[-10%] left-[-10%] w-[500px] h-[500px] rounded-full mix-blend-multiply filter blur-[100px] opacity-30 animate-blob ${isDark ? `bg-${colorTheme}-900 mix-blend-lighten opacity-15` : `${THEME_COLORS[colorTheme]?.blob || 'bg-blue-300'}`}`}></div>
                <div className={`absolute top-[20%] right-[-10%] w-[400px] h-[400px] rounded-full mix-blend-multiply filter blur-[100px] opacity-30 animate-blob animation-delay-2000 ${isDark ? 'bg-purple-900 mix-blend-lighten opacity-15' : 'bg-purple-300'}`}></div>
                <div className={`absolute bottom-[-10%] left-[20%] w-[600px] h-[600px] rounded-full mix-blend-multiply filter blur-[100px] opacity-30 animate-blob animation-delay-4000 ${isDark ? 'bg-blue-900 mix-blend-lighten opacity-15' : 'bg-blue-200'}`}></div>
            </div>
        );

        // 2. Custom Confirmation Modal (Replaces window.confirm)
        const ConfirmModal = ({ isOpen, message, onConfirm, onCancel, isDark }) => {
            if (!isOpen) return null;
            return (
                <div className="fixed inset-0 z-[100] flex items-center justify-center p-6 animate-fadeIn">
                    <div className="absolute inset-0 bg-black/40 backdrop-blur-sm" onClick={onCancel} />
                    <div className={`relative w-full max-w-xs rounded-3xl p-6 shadow-2xl animate-scaleIn border backdrop-blur-xl ${isDark ? 'bg-gray-900/90 border-gray-700 text-white' : 'bg-white/90 border-white/50 text-gray-900'}`}>
                        <h3 className="text-lg font-bold mb-2 text-center">{message}</h3>
                        <div className="flex gap-3 mt-6">
                            <button onClick={onCancel} className={`flex-1 py-3 rounded-xl font-bold text-sm ${isDark ? 'bg-white/10 hover:bg-white/20' : 'bg-gray-100 hover:bg-gray-200'}`}>{TRANSLATIONS['zh-TW'].cancel}</button>
                            <button onClick={onConfirm} className="flex-1 py-3 rounded-xl font-bold text-sm bg-red-500 text-white hover:bg-red-600">{TRANSLATIONS['zh-TW'].confirm}</button>
                        </div>
                    </div>
                </div>
            );
        };

        // 3. Custom Dropdown Select (Replaces <select>)
        const CustomDropdown = ({ options, value, onChange, placeholder, isDark }) => {
            const [isOpen, setIsOpen] = useState(false);
            const selected = options.find(o => o.id === value);
            return (
                <div className="relative w-full">
                    <button onClick={() => setIsOpen(!isOpen)} className={`w-full flex items-center justify-between px-3 py-2 rounded-xl text-xs font-bold border transition-all ${isDark ? 'bg-white/5 border-white/10 text-white' : 'bg-white/60 border-gray-200 text-gray-800'}`}>
                        <span className="truncate">{selected ? selected.name : placeholder}</span><ChevronDown size={14} className="opacity-50"/>
                    </button>
                    {isOpen && (
                        <div className={`absolute top-full mt-1 left-0 w-full z-50 rounded-xl shadow-xl border overflow-hidden max-h-48 overflow-y-auto no-scrollbar animate-slideDown ${isDark ? 'bg-gray-800 border-gray-700' : 'bg-white border-gray-100'}`}>
                            {options.map(opt => (
                                <button key={opt.id} onClick={() => { onChange(opt.id); setIsOpen(false); }} className={`w-full text-left px-3 py-2 text-xs font-bold border-b last:border-0 ${isDark ? 'border-white/5 hover:bg-white/10 text-gray-300' : 'border-gray-50 hover:bg-gray-50 text-gray-600'} ${value === opt.id ? (isDark ? 'bg-white/20 text-white' : 'bg-blue-50 text-blue-600') : ''}`}>
                                    {opt.name}
                                </button>
                            ))}
                        </div>
                    )}
                    {isOpen && <div className="fixed inset-0 z-40" onClick={() => setIsOpen(false)}/>}
                </div>
            );
        };

        // 4. Styled Input (Replaces standard input)
        const StyledInput = ({ value, onChange, placeholder, isDark, className = "" }) => (
            <input type="text" value={value} onChange={onChange} placeholder={placeholder} className={`w-full px-3 py-2 rounded-xl text-sm font-bold border outline-none transition-all placeholder-opacity-50 ${isDark ? 'bg-white/5 border-white/10 text-white placeholder-white focus:bg-white/10 focus:border-white/30' : 'bg-white/60 border-gray-200 text-gray-900 placeholder-gray-400 focus:bg-white focus:border-blue-400 focus:ring-2 focus:ring-blue-100'} ${className}`} />
        );

        // --- Main App ---
        function App() {
            const [user, setUser] = useState(null);
            const [authLoading, setAuthLoading] = useState(true); 
            const [onboardingStep, setOnboardingStep] = useState('welcome');
            
            // Auth State
            const [showEmailAuth, setShowEmailAuth] = useState(false);
            const [isSignUp, setIsSignUp] = useState(false);
            const [email, setEmail] = useState('');
            const [password, setPassword] = useState('');
            const [username, setUsername] = useState('');
            const [authError, setAuthError] = useState('');
            const [rawError, setRawError] = useState('');
            const [showErrorDetails, setShowErrorDetails] = useState(false);
            
            // UI State
            const [showProfileModal, setShowProfileModal] = useState(false);
            const [showRoomMenu, setShowRoomMenu] = useState(false);
            const [activeTab, setActiveTab] = useState('home');
            const [manageTab, setManageTab] = useState('rooms'); 
            const [editingId, setEditingId] = useState(null);
            const [editFormData, setEditFormData] = useState({});
            const [manageSearch, setManageSearch] = useState('');
            const [isAddingNew, setIsAddingNew] = useState(false);

            // Data
            const [items, setItems] = useState([]);
            const [locations, setLocations] = useState([]);
            const [rooms, setRooms] = useState([]);
            const [currentRoom, setCurrentRoom] = useState({ id: 'default', name: 'My Room' });

            // Input State
            const [inputValue, setInputValue] = useState('');
            const [isInputFocused, setIsInputFocused] = useState(false);
            const [activeIcon, setActiveIcon] = useState('üì¶');
            const [showIconPicker, setShowIconPicker] = useState(false);
            const [selectedLocationId, setSelectedLocationId] = useState(null);
            const [isSubmitting, setIsSubmitting] = useState(false);
            
            // Location Add State (Explore Tab)
            const [isAddingLocation, setIsAddingLocation] = useState(false);
            const [newLocName, setNewLocName] = useState('');
            const [newLocIcon, setNewLocIcon] = useState('üì¶');
            const [showLocIconPicker, setShowLocIconPicker] = useState(false);
            const [newRoomName, setNewRoomName] = useState('');

            // Config
            const [config, setConfig] = useState(() => JSON.parse(localStorage.getItem('my_room_config')) || { lang: 'zh-TW', mode: 'light', color: 'blue' });
            const isDark = config.mode === 'dark';
            const themeStyles = THEME_COLORS[config.color];
            const t = TRANSLATIONS[config.lang];
            const [randomHeadline, setRandomHeadline] = useState("");
            
            const [confirmDialog, setConfirmDialog] = useState({ isOpen: false, message: '', onConfirm: null });

            const greetingText = useMemo(() => {
                const h = new Date().getHours();
                if (h < 12) return t.greeting.morning;
                if (h < 18) return t.greeting.afternoon;
                return t.greeting.evening;
            }, [config.lang, t]);

            useEffect(() => {
                localStorage.setItem('my_room_config', JSON.stringify(config));
                const headlines = FUN_HEADLINES[config.lang];
                setRandomHeadline(headlines[Math.floor(Math.random() * headlines.length)]);
            }, [config.lang, config.mode, config.color]);

            useEffect(() => {
                const unsubscribe = onAuthStateChanged(auth, (u) => {
                    setUser(u);
                    setAuthLoading(false);
                });
                return () => unsubscribe();
            }, []);

            // Data Sync & Default Room Logic
            useEffect(() => {
                if (user) {
                    const savedRoomId = localStorage.getItem(`last_room_${user.uid}`);
                    // Will verify if room exists after data loads
                }
            }, [user]);

            useEffect(() => {
                if (!user) return;
                const unsubs = [
                    onSnapshot(query(collection(db, 'artifacts', appId, 'users', user.uid, 'rooms'), orderBy('createdAt', 'asc')), (s) => {
                        const fetched = s.docs.map(d => ({ id: d.id, ...d.data() }));
                        const allRooms = [{ id: 'default', name: t.my_room }, ...fetched];
                        setRooms(allRooms);
                        // Restore room selection
                        const savedId = localStorage.getItem(`last_room_${user.uid}`);
                        if (savedId && allRooms.find(r => r.id === savedId)) {
                            setCurrentRoom(allRooms.find(r => r.id === savedId));
                        }
                    }),
                    onSnapshot(query(collection(db, 'artifacts', appId, 'users', user.uid, 'locations'), orderBy('createdAt', 'asc')), (s) => {
                        const locs = s.docs.map(d => ({ id: d.id, ...d.data() }));
                        setLocations(locs);
                        if (locs.length === 0 && !localStorage.getItem(`init_${user.uid}`)) initDefaultLocations(user.uid);
                    }),
                    onSnapshot(query(collection(db, 'artifacts', appId, 'users', user.uid, 'items'), orderBy('createdAt', 'desc')), (s) => setItems(s.docs.map(d => ({ id: d.id, ...d.data() }))))
                ];
                return () => unsubs.forEach(u => u());
            }, [user, t.my_room]);

            const initDefaultLocations = async (uid) => {
                const defaults = [{ name: 'Êõ∏Ê°å', icon: '‚úèÔ∏è' }, { name: 'Ë°£Ê´É', icon: 'üß•' }, { name: 'Â±§Êû∂', icon: 'üìö' }];
                for (const loc of defaults) await addDoc(collection(db, 'artifacts', appId, 'users', uid, 'locations'), { ...loc, room: 'default', createdAt: serverTimestamp() });
                localStorage.setItem(`init_${uid}`, 'true');
            };

            // Computed Data
            const currentLocations = useMemo(() => locations.filter(l => l.room === currentRoom.id || (!l.room && currentRoom.id === 'default')), [locations, currentRoom]);
            const currentItems = useMemo(() => {
                const locIds = new Set(currentLocations.map(l => l.id));
                return items.filter(i => locIds.has(i.locationId));
            }, [items, currentLocations]);
            const filteredHomeItems = useMemo(() => inputValue ? currentItems.filter(i => i.name.toLowerCase().includes(inputValue.toLowerCase())) : currentItems, [currentItems, inputValue]);
            const isAddMode = inputValue.length > 0 && isInputFocused;

            // Handlers
            const triggerConfirm = (msg, action) => setConfirmDialog({ isOpen: true, message: msg, onConfirm: () => { action(); setConfirmDialog({ isOpen: false, message: '', onConfirm: null }); } });
            const handleGoogleLogin = async () => { try { await signInWithPopup(auth, provider); } catch (e) { console.error(e); } };
            const handleEmailAuth = async (e) => {
                e.preventDefault(); setAuthError(''); setRawError(''); setShowErrorDetails(false);
                try {
                    if (isSignUp) {
                        if (!username.trim()) { setAuthError("Please enter username"); return; }
                        const res = await createUserWithEmailAndPassword(auth, email, password);
                        await updateProfile(res.user, { displayName: username });
                    } else { await signInWithEmailAndPassword(auth, email, password); }
                } catch (error) { setAuthError(error.message); setRawError(error.code); }
            };
            const handleLogout = () => triggerConfirm(t.logout + "?", () => { signOut(auth); setOnboardingStep('welcome'); setShowEmailAuth(false); setShowProfileModal(false); });

            const handleAddItem = async () => {
                if (!inputValue.trim() || !selectedLocationId) return;
                setIsSubmitting(true);
                await addDoc(collection(db, 'artifacts', appId, 'users', user.uid, 'items'), { name: inputValue, locationId: selectedLocationId, icon: activeIcon, tags: [], createdAt: serverTimestamp() });
                setInputValue(''); setIsSubmitting(false);
            };
            const handleDeleteItem = (id) => triggerConfirm(t.confirm_delete, () => deleteDoc(doc(db, 'artifacts', appId, 'users', user.uid, 'items', id)));
            
            const handleAddLocation = async () => {
                if (!newLocName.trim()) return;
                await addDoc(collection(db, 'artifacts', appId, 'users', user.uid, 'locations'), { name: newLocName, icon: newLocIcon, room: currentRoom.id, createdAt: serverTimestamp() });
                setNewLocName(''); setIsAddingLocation(false);
            };
            const handleDeleteLocation = (id) => triggerConfirm(t.delete_loc_confirm, () => deleteDoc(doc(db, 'artifacts', appId, 'users', user.uid, 'locations', id)));
            
            const handleAddRoom = async () => {
                if (!newRoomName.trim()) return;
                const res = await addDoc(collection(db, 'artifacts', appId, 'users', user.uid, 'rooms'), { name: newRoomName, createdAt: serverTimestamp() });
                setNewRoomName(''); setCurrentRoom({ id: res.id, name: newRoomName }); localStorage.setItem(`last_room_${user.uid}`, res.id); setShowRoomMenu(false);
            };

            // Management Logic
            const startAdd = () => { setIsAddingNew(true); setEditingId('new'); setEditFormData({ name: '', icon: 'üì¶', room: currentRoom.id }); };
            const saveManagementItem = async () => {
                try {
                    const coll = manageTab;
                    if (isAddingNew) {
                        const { id, ...data } = editFormData;
                        if(manageTab === 'items' && !data.locationId && locations.length) data.locationId = locations[0].id;
                        if(manageTab === 'locations' && !data.room) data.room = currentRoom.id;
                        await addDoc(collection(db, 'artifacts', appId, 'users', user.uid, coll), { ...data, createdAt: serverTimestamp() });
                    } else {
                        const { id, ...data } = editFormData;
                        await updateDoc(doc(db, 'artifacts', appId, 'users', user.uid, coll, id), data);
                    }
                    setEditingId(null); setIsAddingNew(false); setEditFormData({});
                } catch(e) { console.error(e); }
            };
            const handleDeleteGeneric = (coll, id) => triggerConfirm(t.confirm_delete, () => deleteDoc(doc(db, 'artifacts', appId, 'users', user.uid, coll, id)));

            // --- Sub-renderers ---
            const renderManageRows = () => {
                let list = (manageTab === 'rooms' ? rooms.filter(r => r.id !== 'default') : (manageTab === 'locations' ? locations : items));
                if (manageSearch) list = list.filter(d => d.name.toLowerCase().includes(manageSearch.toLowerCase()));
                
                const renderForm = () => (
                    <div className="flex flex-col gap-3 p-1">
                        <div className="flex gap-2">
                            {manageTab !== 'rooms' && <div className="w-12 shrink-0"><StyledInput value={editFormData.icon} onChange={e => setEditFormData({...editFormData, icon: e.target.value})} isDark={isDark} className="text-center px-0" placeholder="Icon"/></div>}
                            <StyledInput value={editFormData.name} onChange={e => setEditFormData({...editFormData, name: e.target.value})} isDark={isDark} placeholder={t.name}/>
                        </div>
                        
                        {(manageTab === 'locations' || manageTab === 'items') && (
                            <div>
                                {manageTab === 'locations' && <CustomDropdown isDark={isDark} options={rooms} value={editFormData.room || 'default'} onChange={val => setEditFormData({...editFormData, room: val})} placeholder={t.select_room}/>}
                                {manageTab === 'items' && <CustomDropdown isDark={isDark} options={locations} value={editFormData.locationId} onChange={val => setEditFormData({...editFormData, locationId: val})} placeholder={t.select_location}/>}
                            </div>
                        )}
                        
                        <div className="flex gap-2 mt-1">
                             <button onClick={() => { setEditingId(null); setIsAddingNew(false); }} className={`flex-1 py-2.5 rounded-xl font-bold text-xs transition-colors ${isDark ? 'bg-white/10 text-white hover:bg-white/20' : 'bg-gray-100 text-gray-500 hover:bg-gray-200'}`}>{t.cancel}</button>
                            <button onClick={saveManagementItem} className="flex-[2] bg-blue-500 text-white rounded-xl py-2.5 font-bold text-xs shadow-lg hover:bg-blue-600 transition-all">{t.confirm}</button>
                        </div>
                    </div>
                );

                return (
                    <div className="space-y-2 pb-24">
                        {isAddingNew && <div className={`p-4 rounded-2xl border mb-4 animate-scaleIn ${isDark ? 'bg-white/10 border-blue-500/50' : 'bg-white border-blue-200 shadow-lg'}`}><div className="text-xs font-bold text-blue-500 mb-2">{t.add_new}</div>{renderForm()}</div>}
                        {list.map(item => (
                            <div key={item.id} className={`p-3 rounded-2xl border transition-all ${isDark ? 'bg-white/5 border-white/5' : 'bg-white/60 border-white/40 shadow-sm'}`}>
                                {editingId === item.id ? renderForm() : (
                                    <div className="flex items-center justify-between">
                                        <div className="flex items-center gap-3">
                                            {item.icon && <span className="text-xl">{item.icon}</span>}
                                            <div>
                                                <div className={`font-bold text-sm ${isDark ? 'text-gray-200' : 'text-gray-800'}`}>{item.name}</div>
                                                <div className="text-[10px] opacity-50">
                                                    {manageTab === 'locations' && (rooms.find(r => r.id === item.room)?.name || 'Default')}
                                                    {manageTab === 'items' && (locations.find(l => l.id === item.locationId)?.name || 'Unknown')}
                                                </div>
                                            </div>
                                        </div>
                                        <div className="flex gap-2">
                                            <button onClick={() => { setEditingId(item.id); setEditFormData({...item}); }} className={`p-2 rounded-xl ${isDark ? 'bg-white/10 text-gray-300' : 'bg-gray-100 text-gray-600'}`}><PenLine size={14}/></button>
                                            <button onClick={() => handleDeleteGeneric(manageTab, item.id)} className={`p-2 rounded-xl ${isDark ? 'bg-red-500/20 text-red-400' : 'bg-red-100 text-red-500'}`}><Trash2 size={14}/></button>
                                        </div>
                                    </div>
                                )}
                            </div>
                        ))}
                    </div>
                );
            };

            // --- Main Render ---
            if (authLoading) return <div className="h-screen w-full bg-white flex items-center justify-center"><Sparkles className="animate-spin text-gray-400"/></div>;

            if (!user) {
                // Onboarding & Login Flow
                return (
                    <div className={`h-screen w-full flex items-center justify-center font-sans overflow-hidden relative transition-colors duration-500 ${isDark ? 'bg-black text-white' : 'bg-gray-50 text-gray-900'}`}>
                        <AuroraBackground isDark={isDark} colorTheme={config.color} />
                        <div className="relative z-10 p-8 w-full max-w-sm flex flex-col h-full justify-center">
                            {onboardingStep === 'welcome' && (
                                <div className="animate-slideUp flex flex-col items-center text-center">
                                    <div className="text-8xl mb-6 animate-bounce-slight">ü™ê</div>
                                    <h1 className={`text-4xl font-black mb-2 ${isDark ? 'text-white' : 'text-gray-900'}`}>{t.welcome_title}</h1>
                                    <p className={`${isDark ? 'text-white/60' : 'text-gray-500'} mb-10 text-lg`}>{t.welcome_subtitle}</p>
                                    <div className="w-full space-y-4 mb-12">
                                        {[{icon:<Edit3 size={20} className="text-white"/>,bg:'bg-blue-500',text:t.feature_1},{icon:<Search size={20} className="text-white"/>,bg:'bg-purple-500',text:t.feature_2},{icon:<LayoutGrid size={20} className="text-white"/>,bg:'bg-pink-500',text:t.feature_3}].map((f,i)=>(
                                            <div key={i} className={`flex items-center gap-4 p-4 rounded-2xl border ${isDark?'bg-white/10 border-white/10':'bg-white/60 border-white/50 shadow-sm'}`}><div className={`p-2 rounded-lg ${f.bg}`}>{f.icon}</div><div className={`font-bold ${isDark?'text-white':'text-gray-900'}`}>{f.text}</div></div>
                                        ))}
                                    </div>
                                    <div className="w-full mt-auto flex flex-col items-center">
                                        <button onClick={() => setOnboardingStep('language')} className={`w-full py-4 font-bold rounded-2xl shadow-xl active:scale-95 transition-transform flex items-center justify-center gap-2 ${isDark ? 'bg-white text-black' : 'bg-black text-white'}`}>{t.login_btn} <ArrowRight size={20}/></button>
                                        <button onClick={() => setOnboardingStep('login')} className={`text-xs mt-4 transition-colors border-b border-transparent pb-0.5 ${isDark ? 'text-white/40 hover:text-white hover:border-white/40' : 'text-gray-400 hover:text-gray-900 hover:border-gray-400'}`}>{t.login_hint}</button>
                                    </div>
                                </div>
                            )}
                            {onboardingStep === 'language' && (
                                <div className="animate-slideUp flex flex-col items-center text-center w-full">
                                    <button onClick={() => setOnboardingStep('welcome')} className={`absolute top-8 left-6 p-2 rounded-full ${isDark ? 'bg-white/10 text-white' : 'bg-white/60 text-gray-900 shadow-sm'}`}><ArrowRight className="rotate-180" size={20}/></button>
                                    <div className="text-6xl mb-6"><Globe size={64} className={isDark?'text-white/80':'text-gray-800/80'}/></div>
                                    <h2 className={`text-2xl font-bold mb-8 ${isDark?'text-white':'text-gray-900'}`}>{t.select_lang}</h2>
                                    <div className="w-full space-y-3">
                                        {[{code:'zh-TW',label:'ÁπÅÈ´î‰∏≠Êñá'},{code:'zh-CN',label:'ÁÆÄ‰Ωì‰∏≠Êñá'},{code:'en',label:'English'}].map(l=>(<button key={l.code} onClick={()=>{setConfig({...config,lang:l.code});setOnboardingStep('login');}} className={`w-full py-5 border font-bold rounded-2xl transition-all flex justify-between items-center px-6 ${isDark?'bg-white/10 hover:bg-white/20 border-white/10 text-white':'bg-white/60 hover:bg-white border-white/50 text-gray-900 shadow-sm'}`}><span>{l.label}</span><ChevronRight size={20} className="opacity-50"/></button>))}
                                    </div>
                                </div>
                            )}
                            {onboardingStep === 'login' && (
                                <div className="animate-slideUp flex flex-col items-center text-center w-full">
                                    <button onClick={() => setOnboardingStep('language')} className={`absolute top-8 left-6 p-2 rounded-full ${isDark ? 'bg-white/10 text-white' : 'bg-white/60 text-gray-900 shadow-sm'}`}><ArrowRight className="rotate-180" size={20}/></button>
                                    {!showEmailAuth ? (
                                        <React.Fragment>
                                            <h1 className={`text-3xl font-black mb-2 ${isDark?'text-white':'text-gray-900'}`}>{t.login_btn}</h1>
                                            <p className={`mb-10 ${isDark?'text-white/60':'text-gray-500'}`}>{t.welcome_subtitle}</p>
                                            <button onClick={handleGoogleLogin} className={`w-full py-4 font-bold rounded-2xl shadow-xl active:scale-95 transition-transform flex items-center justify-center gap-3 mb-6 ${isDark?'bg-white text-black':'bg-white text-gray-900 border border-gray-100'}`}>
                                                <svg className="w-6 h-6" viewBox="0 0 24 24"><path d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z" fill="#4285F4"/><path d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z" fill="#34A853"/><path d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z" fill="#FBBC05"/><path d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z" fill="#EA4335"/></svg> Google Login
                                            </button>
                                            <div className={`w-full border-t my-4 ${isDark?'border-white/10':'border-gray-200'}`}></div>
                                            <button onClick={() => setShowEmailAuth(true)} className={`text-sm transition-colors ${isDark?'text-white/50 hover:text-white':'text-gray-400 hover:text-gray-900'}`}>{t.no_google}</button>
                                        </React.Fragment>
                                    ) : (
                                        <div className="w-full animate-fadeIn">
                                            <h2 className={`text-2xl font-bold mb-6 ${isDark?'text-white':'text-gray-900'}`}>{isSignUp ? t.register_submit : t.login_submit}</h2>
                                            <form onSubmit={handleEmailAuth} className="space-y-4 w-full">
                                                {isSignUp && (
                                                    <div className={`rounded-xl p-3 flex items-center gap-3 border focus-within:border-opacity-100 transition-colors ${isDark?'bg-white/10 border-white/10 focus-within:border-white/50':'bg-white/60 border-white/50 shadow-sm focus-within:border-blue-400'}`}>
                                                        <User className={isDark?'text-white/50':'text-gray-400'} size={20}/><input type="text" value={username} onChange={e=>setUsername(e.target.value)} placeholder={t.username_ph} className={`bg-transparent border-none placeholder-opacity-50 focus:ring-0 w-full outline-none ${isDark?'text-white placeholder-white':'text-gray-900 placeholder-gray-400'}`} required />
                                                    </div>
                                                )}
                                                <div className={`rounded-xl p-3 flex items-center gap-3 border focus-within:border-opacity-100 transition-colors ${isDark?'bg-white/10 border-white/10 focus-within:border-white/50':'bg-white/60 border-white/50 shadow-sm focus-within:border-blue-400'}`}>
                                                    <Mail className={isDark?'text-white/50':'text-gray-400'} size={20}/><input type="email" value={email} onChange={e=>setEmail(e.target.value)} placeholder={t.email_ph} className={`bg-transparent border-none placeholder-opacity-50 focus:ring-0 w-full outline-none ${isDark?'text-white placeholder-white':'text-gray-900 placeholder-gray-400'}`} required />
                                                </div>
                                                <div className={`rounded-xl p-3 flex items-center gap-3 border focus-within:border-opacity-100 transition-colors ${isDark?'bg-white/10 border-white/10 focus-within:border-white/50':'bg-white/60 border-white/50 shadow-sm focus-within:border-blue-400'}`}>
                                                    <Lock className={isDark?'text-white/50':'text-gray-400'} size={20}/><input type="password" value={password} onChange={e=>setPassword(e.target.value)} placeholder={t.password_ph} className={`bg-transparent border-none placeholder-opacity-50 focus:ring-0 w-full outline-none ${isDark?'text-white placeholder-white':'text-gray-900 placeholder-gray-400'}`} required minLength={6} />
                                                </div>
                                                {authError && (
                                                    <div className="bg-red-900/10 border border-red-500/50 rounded-xl p-3 mt-2 text-left">
                                                        <div className="flex justify-between items-start gap-2"><span className="text-red-500 text-xs font-bold">{authError}</span><button type="button" onClick={()=>setShowErrorDetails(!showErrorDetails)} className="text-[10px] text-red-400 underline shrink-0">Ë©≥Á¥∞</button></div>
                                                        {showErrorDetails && <div className="mt-2 pt-2 border-t border-red-500/20 text-[10px] font-mono text-red-400 break-all">{rawError}</div>}
                                                    </div>
                                                )}
                                                <button type="submit" className={`w-full py-4 font-bold rounded-2xl shadow-lg mt-4 active:scale-95 transition-transform ${isDark?'bg-white text-black':'bg-black text-white'}`}>{isSignUp ? t.register_submit : t.login_submit}</button>
                                            </form>
                                            <button onClick={()=>{setIsSignUp(!isSignUp);setAuthError('');}} className={`mt-6 text-sm hover:text-opacity-80 transition-colors ${isDark?'text-white/50':'text-gray-500'}`}>{isSignUp ? t.switch_to_login : t.switch_to_register}</button>
                                        </div>
                                    )}
                                </div>
                            )}
                        </div>
                        <div className={`fixed bottom-4 right-6 text-[10px] font-mono pointer-events-none select-none opacity-20 ${isDark?'text-white':'text-black'}`}>@colasonyt1123</div>
                    </div>
                );
            }

            // --- App (Logged In) ---
            return (
                <div className={`h-screen w-full flex justify-center font-sans overflow-hidden transition-colors duration-500 ${isDark ? 'bg-black text-white' : 'bg-gray-50 text-gray-900'}`}>
                    <div className={`w-full max-w-md h-full flex flex-col relative shadow-2xl ${isDark ? 'bg-[#0a0a0a]' : 'bg-[#FAFAFA]'}`}>
                        <AuroraBackground isDark={isDark} colorTheme={config.color} />

                        {/* TOP BAR */}
                        <div className={`absolute top-0 left-0 right-0 pt-12 pb-4 px-6 flex justify-between items-center z-50 border-b transition-colors duration-300 ${isDark ? 'border-white/10' : 'border-black/5'}`}>
                            <button onClick={()=>setShowRoomMenu(!showRoomMenu)} className={`flex items-center gap-1 font-black text-xl tracking-tighter hover:opacity-70 transition-opacity ${isDark?'text-white':'text-gray-900'}`}>{currentRoom.name} <ChevronDown size={16}/></button>
                            <div className={`flex items-center p-1 rounded-full border shadow-sm backdrop-blur-md ${isDark ? 'bg-gray-800/50 border-white/10' : 'bg-white/60 border-white/20'}`}>
                                {[{id:'home',icon:Home}, {id:'explore',icon:FolderOpen}, {id:'management',icon:Database}, {id:'profile',icon:Settings}].map(tb=>(
                                    <button key={tb.id} onClick={()=>setActiveTab(tb.id)} className={`p-2.5 rounded-full relative transition-all ${activeTab===tb.id?(isDark?'bg-gray-700 text-white shadow-md':'bg-white text-gray-900 shadow-md'):(isDark?'text-gray-400 hover:text-white':'text-gray-500 hover:text-gray-900')}`}><tb.icon size={18} strokeWidth={activeTab===tb.id?2.5:2}/></button>
                                ))}
                            </div>
                            <button onClick={()=>setShowProfileModal(true)} className="w-9 h-9 rounded-full bg-gradient-to-br from-gray-200 to-gray-400 p-[2px] shadow-sm"><img src={user.photoURL} className="w-full h-full rounded-full bg-white object-cover"/></button>
                        </div>

                        {/* Room Menu */}
                        {showRoomMenu && (
                            <>
                                <div className="fixed inset-0 z-40" onClick={() => setShowRoomMenu(false)}/>
                                <div className={`absolute top-24 left-6 z-[60] w-48 rounded-2xl shadow-xl border overflow-hidden animate-slideDown backdrop-blur-xl ${isDark ? 'bg-gray-900/90 border-gray-700' : 'bg-white/90 border-gray-200'}`}>
                                    <div className="max-h-60 overflow-y-auto no-scrollbar p-2">
                                        {rooms.map(r => (
                                            <button key={r.id} onClick={() => { setCurrentRoom(r); localStorage.setItem(`last_room_${user.uid}`, r.id); setShowRoomMenu(false); }} className={`w-full text-left px-3 py-2 rounded-xl text-xs font-bold flex justify-between ${currentRoom.id === r.id ? (isDark ? 'bg-white text-black' : 'bg-black text-white') : (isDark ? 'text-gray-300 hover:bg-white/10' : 'text-gray-600 hover:bg-gray-100')}`}>
                                                {r.name} {currentRoom.id === r.id && <Check size={12}/>}
                                            </button>
                                        ))}
                                    </div>
                                    <div className={`p-2 border-t ${isDark ? 'border-gray-700' : 'border-gray-200'}`}>
                                        <div className={`flex items-center gap-2 px-2 py-1 rounded-xl ${isDark ? 'bg-gray-800' : 'bg-gray-100'}`}>
                                            <Plus size={14} className={isDark ? 'text-gray-400' : 'text-gray-500'}/>
                                            <input type="text" value={newRoomName} onChange={(e) => setNewRoomName(e.target.value)} onKeyDown={(e) => e.key === 'Enter' && handleAddRoom()} placeholder={t.add_room} className={`w-full bg-transparent border-none text-xs focus:ring-0 ${isDark ? 'text-white' : 'text-gray-900'}`} />
                                        </div>
                                    </div>
                                </div>
                            </>
                        )}

                        {/* CONTENTS */}
                        <div className="flex-1 overflow-y-auto no-scrollbar pt-36 px-5 relative z-10">
                            {/* HOME TAB */}
                            {activeTab === 'home' && (
                                <div className="space-y-6 pb-24 animate-slideUp">
                                    <div className="mb-6">
                                        <div className={`text-xs font-bold uppercase tracking-wider mb-1 flex items-center gap-1.5 ${isDark ? 'text-gray-400' : 'text-gray-500'}`}><Sparkles size={12} className={themeStyles.text} /> {greetingText}</div>
                                        <h1 className={`text-3xl font-black tracking-tight ${isDark ? 'text-white' : 'text-gray-900'}`}><span className={`text-transparent bg-clip-text bg-gradient-to-r ${themeStyles.from} ${themeStyles.to}`}>{randomHeadline}</span></h1>
                                    </div>
                                    <div className={`relative backdrop-blur-xl border transition-all duration-300 ease-spring ${isAddMode ? `rounded-3xl shadow-2xl ring-1 ${themeStyles.border} bg-white/90 dark:bg-black/80` : 'rounded-2xl shadow-sm bg-white/40 dark:bg-white/5'} ${isDark ? 'border-white/20' : 'border-white/60'}`}>
                                        <div className="flex items-center p-2">
                                            <button onClick={() => setShowIconPicker(!showIconPicker)} className={`w-11 h-11 rounded-xl flex items-center justify-center text-xl transition-colors shrink-0 border ${isDark ? 'border-white/10 bg-white/5 text-white hover:bg-white/10' : 'border-white/50 bg-white/50 text-gray-900 hover:bg-white/80'}`}>{activeIcon}</button>
                                            <input type="text" value={inputValue} onFocus={() => setIsInputFocused(true)} onChange={(e) => setInputValue(e.target.value)} placeholder={t.search_placeholder} className={`flex-1 bg-transparent border-none text-base font-bold px-3 focus:ring-0 ${isDark ? 'text-white placeholder-white/30' : 'text-gray-900 placeholder-gray-500'}`} />
                                            {inputValue && <button onClick={() => {setInputValue(''); setIsInputFocused(false);}} className={`p-2 rounded-full ${isDark ? 'text-white/50 hover:bg-white/10' : 'text-gray-500 hover:bg-black/5'}`}><X size={14} /></button>}
                                        </div>
                                        {showIconPicker && <IconPicker selectedIcon={activeIcon} onSelect={setActiveIcon} onClose={() => setShowIconPicker(false)} isDark={isDark} />}
                                        <div className={`overflow-hidden transition-all duration-500 ease-in-out ${isAddMode ? 'max-h-64 opacity-100 border-t ' + (isDark ? 'border-white/10' : 'border-black/5') : 'max-h-0 opacity-0'}`}>
                                            <div className="p-3">
                                                <div className="flex gap-2 overflow-x-auto pb-2 no-scrollbar">
                                                    {currentLocations.map(loc => (<button key={loc.id} onClick={() => setSelectedLocationId(loc.id)} className={`flex items-center gap-2 px-3 py-2.5 rounded-xl border transition-all shrink-0 ${selectedLocationId === loc.id ? `${themeStyles.bg} text-white border-transparent shadow-md scale-105` : `${isDark ? 'bg-white/10 border-white/20 text-gray-300' : 'bg-white border-gray-200 text-gray-600'}`}`}><span>{loc.icon}</span><span className="font-bold text-xs">{loc.name}</span></button>))}
                                                </div>
                                                {selectedLocationId && <button onClick={handleAddItem} disabled={isSubmitting} className={`w-full mt-2 bg-gradient-to-r ${themeStyles.from} ${themeStyles.to} text-white font-bold py-3 rounded-xl shadow-lg active:scale-95 transition-all flex items-center justify-center gap-2 animate-bounce-slight`}>{isSubmitting ? <Sparkles size={16} className="animate-spin"/> : <Save size={16}/>} {t.save_btn}</button>}
                                            </div>
                                        </div>
                                    </div>
                                    <div className="space-y-3">
                                        {filteredHomeItems.map(item => (
                                            <div key={item.id} className={`flex items-center justify-between p-4 rounded-2xl border transition-all ${isDark ? 'bg-white/5 border-white/5' : 'bg-white/60 border-white/40 shadow-sm'}`}>
                                                <div className="flex items-center gap-3"><span className="text-xl">{item.icon}</span><div><div className={`font-bold text-sm ${isDark ? 'text-gray-200' : 'text-gray-800'}`}>{item.name}</div><div className="text-[10px] opacity-50 flex items-center gap-1"><MapPin size={10}/> {locations.find(l => l.id === item.locationId)?.name}</div></div></div>
                                                <button onClick={() => handleDeleteItem(item.id)} className="opacity-30 hover:opacity-100"><Trash2 size={16}/></button>
                                            </div>
                                        ))}
                                    </div>
                                </div>
                            )}

                            {/* EXPLORE TAB */}
                            {activeTab === 'explore' && (
                                <div className="pb-24 animate-fadeIn">
                                    <div className="grid grid-cols-2 gap-3">
                                        {currentLocations.map((loc, idx) => {
                                            const count = items.filter(i => i.locationId === loc.id).length;
                                            return (
                                                <div key={loc.id} className={`p-4 rounded-3xl border flex flex-col justify-between h-32 transition-all ${isDark ? 'bg-white/5 border-white/5 hover:bg-white/10' : 'bg-white/60 border-white/40 shadow-sm hover:bg-white/80'}`} style={{animationDelay: `${idx*0.05}s`}}>
                                                    <div className="flex justify-between items-start"><span className="text-3xl">{loc.icon}</span><span className={`text-xs font-bold px-2 py-1 rounded-full ${isDark ? 'bg-white/10' : 'bg-gray-100 text-gray-500'}`}>{count}</span></div>
                                                    <div className={`font-bold ${isDark ? 'text-white' : 'text-gray-800'}`}>{loc.name}</div>
                                                </div>
                                            )
                                        })}
                                        <button onClick={() => { setActiveTab('management'); setManageTab('locations'); startAdd(); }} className={`rounded-3xl border border-dashed flex flex-col items-center justify-center h-32 ${isDark ? 'border-white/10 text-white/30 hover:border-white/30 hover:text-white' : 'border-gray-300 text-gray-400 hover:border-gray-400 hover:text-gray-600'}`}>
                                            <Plus size={24}/><span className="text-xs font-bold mt-2">{t.add_new}</span>
                                        </button>
                                    </div>
                                </div>
                            )}

                            {/* MANAGEMENT TAB */}
                            {activeTab === 'management' && (
                                <div className="space-y-4 animate-fadeIn pb-24">
                                    <div className="flex items-center justify-between mb-2">
                                        <div className="flex gap-2 bg-gray-500/10 p-1 rounded-xl">
                                            {['rooms', 'locations', 'items'].map(m => (<button key={m} onClick={() => { setManageTab(m); setIsAddingNew(false); setEditingId(null); }} className={`px-3 py-1.5 rounded-lg text-xs font-bold transition-all ${manageTab === m ? (isDark ? 'bg-white text-black' : 'bg-black text-white') : 'opacity-50'}`}>{t[`manage_${m}`]}</button>))}
                                        </div>
                                        <button onClick={startAdd} className={`p-2 rounded-xl ${isDark ? 'bg-blue-600 text-white' : 'bg-blue-500 text-white'}`}><Plus size={20}/></button>
                                    </div>
                                    {manageTab === 'items' && (<div className="flex items-center gap-2 mb-2"><Search size={16} className="opacity-50"/><StyledInput value={manageSearch} onChange={e => setManageSearch(e.target.value)} placeholder={t.search} isDark={isDark} className="bg-transparent border-none px-0"/></div>)}
                                    {renderManageRows()}
                                </div>
                            )}

                            {/* PROFILE TAB */}
                            {activeTab === 'profile' && (
                                <div className="space-y-6 animate-fadeIn pb-24">
                                    <div className={`p-6 rounded-3xl border flex items-center gap-4 ${isDark ? 'bg-white/5 border-white/5' : 'bg-white/60 border-white/40 shadow-sm'}`}>
                                        <img src={user.photoURL} className="w-16 h-16 rounded-full bg-gray-200"/>
                                        <div><div className={`font-black text-xl ${isDark ? 'text-white' : 'text-gray-900'}`}>{user.displayName || 'User'}</div><div className="text-xs opacity-50">{user.email}</div></div>
                                    </div>
                                    <div className="space-y-2"><div className="text-xs font-bold opacity-50 uppercase pl-2">{t.appearance}</div><div className={`p-1 rounded-2xl grid grid-cols-2 gap-1 ${isDark ? 'bg-white/5' : 'bg-gray-100'}`}><button onClick={() => setConfig({...config, mode: 'light'})} className={`py-2 rounded-xl text-xs font-bold flex items-center justify-center gap-2 ${config.mode === 'light' ? 'bg-white shadow-sm text-black' : 'opacity-50'}`}><Sun size={14}/> Light</button><button onClick={() => setConfig({...config, mode: 'dark'})} className={`py-2 rounded-xl text-xs font-bold flex items-center justify-center gap-2 ${config.mode === 'dark' ? 'bg-gray-700 shadow-sm text-white' : 'opacity-50'}`}><Moon size={14}/> Dark</button></div></div>
                                    <div className="space-y-2"><div className="text-xs font-bold opacity-50 uppercase pl-2">{t.theme_color}</div><div className="flex justify-between px-2">{Object.keys(THEME_COLORS).map(key => (<button key={key} onClick={() => setConfig({...config, color: key})} className={`w-8 h-8 rounded-full flex items-center justify-center transition-transform ${THEME_COLORS[key].bg} ${config.color === key ? 'scale-110 ring-2 ring-offset-2 ' + (isDark ? 'ring-offset-black' : 'ring-offset-white') : 'opacity-50'}`}>{config.color === key && <Check size={14} className="text-white"/>}</button>))}</div></div>
                                    <button onClick={handleLogout} className="w-full py-4 text-red-500 font-bold text-sm bg-red-500/10 rounded-2xl mt-4">{t.logout}</button>
                                </div>
                            )}
                        </div>

                        {/* Modals */}
                        <ConfirmModal isOpen={confirmDialog.isOpen} message={confirmDialog.message} onConfirm={confirmDialog.onConfirm} onCancel={() => setConfirmDialog({...confirmDialog, isOpen: false})} isDark={isDark} />
                        {showProfileModal && (
                            <div className="fixed inset-0 z-[100] flex items-center justify-center p-6 animate-fadeIn">
                                <div className="absolute inset-0 bg-black/40 backdrop-blur-sm" onClick={() => setShowProfileModal(false)} />
                                <div className={`relative w-full max-w-xs rounded-3xl p-6 shadow-2xl animate-scaleIn border backdrop-blur-xl ${isDark ? 'bg-gray-900/90 border-gray-700 text-white' : 'bg-white/90 border-white/50 text-gray-900'}`}>
                                    <div className="flex flex-col items-center gap-4"><img src={user.photoURL} className="w-20 h-20 rounded-full border-4 border-white shadow-lg"/><div className="text-center"><div className="font-black text-xl">{user.displayName || 'User'}</div><div className="text-xs opacity-50">{user.email}</div></div><button onClick={handleLogout} className="w-full py-3 bg-red-500 text-white font-bold rounded-xl text-sm shadow-lg mt-2">{t.logout}</button></div>
                                </div>
                            </div>
                        )}
                        <div className={`absolute bottom-6 right-6 text-[10px] font-mono font-bold pointer-events-none select-none opacity-20 ${isDark ? 'text-white' : 'text-black'}`}>@colasonyt1123</div>
                    </div>
                </div>
            );
        }

        const root = createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>